<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Instagram Content Planner</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. CONFIGURAÇÕES GERAIS E VARIÁVEIS --- */
        :root {
            --primary: #3D4E9F;
            --secondary: #FFD700;
            --accent: #E63946;
            --dark: #2B2D42;
            --light: #F4F6F8;
            --white: #FFFFFF;
            --gray: #8D99AE;
            --success: #2a9d8f;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 12px;
            --font-main: 'Inter', sans-serif;
            --header-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--light);
            color: var(--dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* App-like feel */
        }

        /* --- 2. HEADER --- */
        header {
            background-color: var(--primary);
            color: var(--white);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            box-shadow: var(--shadow-md);
            z-index: 100;
        }

        .logo-area { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.1rem; }
        .logo-icon { color: var(--secondary); font-size: 1.4rem; }
        
        .header-actions { display: flex; gap: 10px; }
        .btn-icon {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px; /* Touch target */
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.3); }

        /* --- 3. LAYOUT PRINCIPAL --- */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar (Biblioteca de Ideias) */
        .sidebar {
            width: 300px;
            background: var(--white);
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 90;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .idea-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .idea-category {
            margin-bottom: 1.5rem;
        }
        .category-title {
            font-size: 0.85rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .idea-card {
            background: var(--white);
            border: 1px solid #eee;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: grab;
            box-shadow: var(--shadow-sm);
            font-size: 0.9rem;
            transition: 0.2s;
            position: relative;
        }
        .idea-card:hover, .idea-card.selected {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .idea-card.selected {
            background-color: #eef2ff;
            border: 2px solid var(--primary);
        }
        
        .chip {
            display: inline-block;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: #eee;
            color: #555;
            margin-top: 5px;
        }

        /* Área do Calendário */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-controls {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
            border-bottom: 1px solid #ddd;
        }

        .calendar-grid {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: grid;
            gap: 1rem;
            /* Default Mobile: 1 Column */
            grid-template-columns: 1fr; 
        }

        .day-column {
            background: var(--white);
            border-radius: var(--radius);
            min-height: 150px;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .day-header {
            padding: 10px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius) var(--radius) 0 0;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }
        .day-header.today { background: var(--accent); }

        .day-slots {
            padding: 10px;
            flex: 1;
            min-height: 100px;
            transition: background 0.3s;
        }
        .day-slots.drag-over { background: #eef2ff; border: 2px dashed var(--primary); }

        .scheduled-post {
            background: var(--white);
            border-left: 4px solid var(--secondary);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: var(--shadow-sm);
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
        }
        .scheduled-post.status-published { border-left-color: var(--success); opacity: 0.7; }
        .scheduled-post.status-draft { border-left-color: var(--gray); }
        
        .post-title { font-weight: 600; margin-bottom: 4px; display: block;}
        .post-meta { font-size: 0.75rem; color: #666; display: flex; justify-content: space-between; }

        /* --- 4. MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            background: var(--light);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem; /* Prevent zoom on iOS */
        }
        textarea.form-control { resize: vertical; min-height: 80px; }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-danger { background: var(--accent); color: white; }

        /* --- 5. FAB (Floating Action Button) --- */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--secondary);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 1.5rem;
            z-index: 95;
            border: none;
            cursor: pointer;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(43, 45, 66, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            z-index: 300;
            text-align: center;
            width: max-content;
            max-width: 80%;
        }
        .toast.show { opacity: 1; bottom: 100px; }

        /* --- 6. RESPONSIVIDADE --- */
        
        /* Mobile (Default Styles above match Mobile First) */
        @media (max-width: 767px) {
            .sidebar {
                position: absolute;
                top: 0; bottom: 0; left: 0;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(0); }
            
            .modal { width: 100%; height: 100%; max-height: 100%; border-radius: 0; max-width: none;}
            .calendar-controls h2 { font-size: 1rem; }
        }

        /* Tablet */
        @media (min-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 cols grid */
            }
            .fab { display: none; } /* Use sidebar toggle in header or keep sidebar visible */
            .sidebar {
                position: relative;
                transform: translateX(0); /* Always visible on larger screens unless toggled */
                width: 250px;
            }
            .sidebar.collapsed { width: 0; overflow: hidden; border: none; }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr); /* Full week view */
            }
            .sidebar { width: 300px; }
            .app-container { flex-direction: row-reverse; } /* Sidebar on right for desktop preference */
            .day-column { min-height: 300px; }
        }

        /* Drag Helper */
        .dragging { opacity: 0.5; }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <i class="fas fa-calendar-alt logo-icon"></i>
            <span>InstaPlanner</span>
        </div>
        <div class="header-actions">
            <button class="btn-icon" onclick="exportCalendar()" title="Exportar como Imagem">
                <i class="fas fa-camera"></i>
            </button>
            <button class="btn-icon" onclick="resetData()" title="Limpar Tudo">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button class="btn-icon mobile-only" onclick="toggleSidebar()" id="menuBtn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <main class="app-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>Biblioteca de Ideias</span>
                <button class="btn-icon" style="color:var(--dark)" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="idea-list" id="ideaList">
                </div>
        </aside>

        <section class="main-content" id="captureArea">
            <div class="calendar-controls">
                <button class="btn-secondary btn" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentMonthYear">Janeiro 2026</h2>
                <button class="btn-secondary btn" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                </div>
        </section>

    </main>

    <button class="fab" onclick="toggleSidebar()">
        <i class="fas fa-lightbulb"></i>
    </button>

    <div class="modal-overlay" id="postModal">
        <div class="modal">
            <div class="modal-header">
                <span id="modalTitle">Planejar Post</span>
                <button onclick="closeModal()" style="background:none;border:none;font-size:1.2rem;cursor:pointer">&times;</button>
            </div>
            <div class="modal-body">
                <form id="postForm">
                    <input type="hidden" id="postId">
                    <input type="hidden" id="postDayId">
                    
                    <div class="form-group">
                        <label>Título / Ideia</label>
                        <input type="text" id="postTitle" class="form-control" required placeholder="Ex: Foto do produto">
                    </div>

                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="postCategory" class="form-control">
                            <option value="produto">Produto</option>
                            <option value="motivacao">Motivação</option>
                            <option value="educacional">Educacional</option>
                            <option value="bastidores">Bastidores</option>
                            <option value="venda">Venda/Oferta</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="postStatus" class="form-control">
                            <option value="draft">Rascunho (Ideia)</option>
                            <option value="planned">Planejado (Produzindo)</option>
                            <option value="published">Publicado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Legenda</label>
                        <textarea id="postCaption" class="form-control" placeholder="Escreva a legenda aqui..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="btnDeletePost" style="margin-right:auto" onclick="deletePost()">Excluir</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="savePost()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Mensagem aqui</div>

    <script>
        /* --- DADOS INICIAIS (BASEADO NO PROMPT) --- */
        const SUGGESTED_IDEAS = {
            'Segunda': [
                { title: 'Motivação para segunda', cat: 'motivacao' },
                { title: 'Mostrar espaço de trabalho', cat: 'bastidores' },
                { title: 'Foto dia a dia da marca', cat: 'bastidores' },
                { title: 'Opções do produto', cat: 'produto' }
            ],
            'Terça': [
                { title: 'Oferta do produto', cat: 'venda' },
                { title: 'Foto apenas do produto', cat: 'produto' },
                { title: 'Vídeo sobre a marca', cat: 'educacional' },
                { title: 'Feedbacks do produto', cat: 'produto' }
            ],
            'Quarta': [
                { title: 'Problemas que resolve', cat: 'educacional' },
                { title: 'Como é feito', cat: 'bastidores' },
                { title: 'Diferentes usos', cat: 'educacional' },
                { title: 'Foto apenas do produto', cat: 'produto' }
            ],
            'Quinta': [
                { title: 'História do produto', cat: 'educacional' },
                { title: 'Dicas de aproveitamento', cat: 'educacional' },
                { title: 'Diferenciais da marca', cat: 'produto' },
                { title: 'Frase de motivação', cat: 'motivacao' }
            ],
            'Sexta': [
                { title: 'Causa que a marca apoia', cat: 'motivacao' },
                { title: 'Quem está por trás', cat: 'bastidores' },
                { title: 'Diferentes maneiras de uso', cat: 'educacional' }
            ],
            'Sábado': [
                { title: 'Campanha de marketing', cat: 'venda' },
                { title: 'Defender uma causa', cat: 'motivacao' },
                { title: 'Dica rápida', cat: 'educacional' }
            ],
            'Domingo': [
                { title: 'Feedbacks', cat: 'produto' },
                { title: 'Diferenciais do produto', cat: 'produto' },
                { title: 'Foto close-up', cat: 'produto' }
            ]
        };

        /* --- ESTADO DA APLICAÇÃO --- */
        const AppState = {
            currentDate: new Date(), // Data de referência para a semana
            posts: {}, // Estrutura: { "YYYY-MM-DD": [ {id, title, status...} ] }
            selectedIdea: null, // Para mobile tap-to-place
            isMobile: window.innerWidth < 768
        };

        /* --- INICIALIZAÇÃO --- */
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            renderSidebar();
            renderCalendar();
            setupEventListeners();
        });

        window.addEventListener('resize', () => {
            AppState.isMobile = window.innerWidth < 768;
            renderCalendar(); // Re-renderizar se necessário para ajuste de layout
        });

        /* --- FUNÇÕES DE RENDERIZAÇÃO --- */

        function renderSidebar() {
            const list = document.getElementById('ideaList');
            list.innerHTML = '';

            for (const [day, ideas] of Object.entries(SUGGESTED_IDEAS)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'idea-category';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = `Sugestões para ${day}`;
                categoryDiv.appendChild(title);

                ideas.forEach(idea => {
                    const card = document.createElement('div');
                    card.className = 'idea-card';
                    card.draggable = true; // Desktop Drag
                    card.innerHTML = `
                        <div>${idea.title}</div>
                        <span class="chip">${idea.cat}</span>
                    `;
                    
                    // Desktop Drag Event
                    card.addEventListener('dragstart', (e) => handleDragStart(e, idea));
                    
                    // Mobile Tap Event
                    card.addEventListener('click', () => handleIdeaSelect(card, idea));

                    categoryDiv.appendChild(card);
                });

                list.appendChild(categoryDiv);
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Determinar o início da semana (Segunda-feira)
            const curr = new Date(AppState.currentDate);
            const day = curr.getDay(); 
            const diff = curr.getDate() - day + (day === 0 ? -6 : 1); // Ajuste para segunda ser o primeiro dia
            const monday = new Date(curr.setDate(diff));

            // Atualizar cabeçalho
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('currentMonthYear').textContent = `${monthNames[monday.getMonth()]} ${monday.getFullYear()}`;

            const weekDays = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];

            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                const isToday = new Date().toISOString().split('T')[0] === dateStr;

                const dayCol = document.createElement('div');
                dayCol.className = 'day-column';
                
                // Header do Dia
                const dayHeader = document.createElement('div');
                dayHeader.className = `day-header ${isToday ? 'today' : ''}`;
                dayHeader.innerHTML = `<span>${weekDays[i]}</span> <span>${date.getDate()}</span>`;
                dayCol.appendChild(dayHeader);

                // Slot de Posts
                const slot = document.createElement('div');
                slot.className = 'day-slots';
                slot.dataset.date = dateStr;

                // Eventos de Drop (Desktop) e Click (Mobile Place)
                slot.addEventListener('dragover', (e) => e.preventDefault());
                slot.addEventListener('dragenter', (e) => slot.classList.add('drag-over'));
                slot.addEventListener('dragleave', (e) => slot.classList.remove('drag-over'));
                slot.addEventListener('drop', (e) => handleDrop(e, dateStr));
                slot.addEventListener('click', (e) => handleSlotClick(e, dateStr));

                // Renderizar Posts existentes
                if (AppState.posts[dateStr]) {
                    AppState.posts[dateStr].forEach(post => {
                        const postEl = createPostElement(post);
                        slot.appendChild(postEl);
                    });
                }

                dayCol.appendChild(slot);
                grid.appendChild(dayCol);
            }
        }

        function createPostElement(post) {
            const el = document.createElement('div');
            el.className = `scheduled-post status-${post.status}`;
            el.draggable = true;
            el.innerHTML = `
                <span class="post-title">${post.title}</span>
                <div class="post-meta">
                    <span>${post.category}</span>
                    ${post.status === 'published' ? '<i class="fas fa-check"></i>' : ''}
                </div>
            `;
            
            // Click para editar
            el.addEventListener('click', (e) => {
                e.stopPropagation(); // Evita trigger no slot
                openModal(post);
            });

            // Drag para mover entre dias (Desktop)
            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'move', id: post.id, date: post.date }));
            });

            return el;
        }

        /* --- LÓGICA DE INTERAÇÃO (DRAG / TOUCH) --- */

        // Desktop: Iniciar Drag da Biblioteca
        function handleDragStart(e, idea) {
            e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'new', title: idea.title, category: idea.cat }));
        }

        // Desktop: Soltar no Calendário
        function handleDrop(e, dateStr) {
            e.preventDefault();
            document.querySelectorAll('.day-slots').forEach(d => d.classList.remove('drag-over'));
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            
            if (data.type === 'new') {
                addNewPost(dateStr, data.title, data.category);
            } else if (data.type === 'move') {
                movePost(data.id, data.date, dateStr);
            }
        }

        // Mobile: Selecionar Ideia (Tap 1)
        function handleIdeaSelect(cardElement, idea) {
            // Se já selecionado, desmarcar
            if (AppState.selectedIdea && AppState.selectedIdea.title === idea.title) {
                AppState.selectedIdea = null;
                document.querySelectorAll('.idea-card').forEach(c => c.classList.remove('selected'));
                return;
            }

            // Marcar novo
            document.querySelectorAll('.idea-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');
            AppState.selectedIdea = idea;
            
            showToast("Toque em um dia no calendário para adicionar");
            
            // No mobile, fechar sidebar para ver o calendário
            if (window.innerWidth < 768) {
                setTimeout(toggleSidebar, 300);
            }
        }

        // Mobile: Clicar no Slot (Tap 2 ou Novo)
        function handleSlotClick(e, dateStr) {
            if (AppState.selectedIdea) {
                // Adicionar ideia selecionada
                addNewPost(dateStr, AppState.selectedIdea.title, AppState.selectedIdea.cat);
                
                // Limpar seleção
                AppState.selectedIdea = null;
                document.querySelectorAll('.idea-card').forEach(c => c.classList.remove('selected'));
                showToast("Post adicionado!");
            } else {
                // Abrir modal para criar novo post do zero
                openModal(null, dateStr);
            }
        }

        /* --- CRUD POSTS --- */

        function addNewPost(date, title, category) {
            if (!AppState.posts[date]) AppState.posts[date] = [];
            
            const newPost = {
                id: Date.now().toString(),
                date: date,
                title: title,
                category: category || 'motivacao',
                status: 'draft',
                caption: ''
            };
            
            AppState.posts[date].push(newPost);
            saveToStorage();
            renderCalendar();
        }

        function movePost(id, oldDate, newDate) {
            if (oldDate === newDate) return;

            const postIndex = AppState.posts[oldDate].findIndex(p => p.id === id);
            if (postIndex > -1) {
                const post = AppState.posts[oldDate].splice(postIndex, 1)[0];
                post.date = newDate;
                
                if (!AppState.posts[newDate]) AppState.posts[newDate] = [];
                AppState.posts[newDate].push(post);
                
                saveToStorage();
                renderCalendar();
            }
        }

        function savePost() {
            const id = document.getElementById('postId').value;
            const date = document.getElementById('postDayId').value;
            const title = document.getElementById('postTitle').value;
            
            if (!title) return alert('Título é obrigatório');

            if (id) {
                // Editar existente
                const post = AppState.posts[date].find(p => p.id === id);
                if (post) {
                    post.title = title;
                    post.category = document.getElementById('postCategory').value;
                    post.status = document.getElementById('postStatus').value;
                    post.caption = document.getElementById('postCaption').value;
                }
            } else {
                // Novo via modal
                addNewPost(date, title, document.getElementById('postCategory').value);
                // Atualizar detalhes extras que o addNewPost padrão não pega
                const list = AppState.posts[date];
                const created = list[list.length-1];
                created.status = document.getElementById('postStatus').value;
                created.caption = document.getElementById('postCaption').value;
            }

            saveToStorage();
            renderCalendar();
            closeModal();
            showToast("Salvo com sucesso!");
        }

        function deletePost() {
            const id = document.getElementById('postId').value;
            const date = document.getElementById('postDayId').value;
            
            if (id && AppState.posts[date]) {
                AppState.posts[date] = AppState.posts[date].filter(p => p.id !== id);
                saveToStorage();
                renderCalendar();
                closeModal();
                showToast("Post removido");
            }
        }

        /* --- MODAL E UI --- */

        function openModal(post, dateStr) {
            const modal = document.getElementById('postModal');
            const btnDelete = document.getElementById('btnDeletePost');
            
            if (post) {
                // Modo Edição
                document.getElementById('modalTitle').textContent = "Editar Post";
                document.getElementById('postId').value = post.id;
                document.getElementById('postDayId').value = post.date;
                document.getElementById('postTitle').value = post.title;
                document.getElementById('postCategory').value = post.category;
                document.getElementById('postStatus').value = post.status;
                document.getElementById('postCaption').value = post.caption || '';
                btnDelete.style.display = 'block';
            } else {
                // Modo Novo
                document.getElementById('modalTitle').textContent = "Novo Post";
                document.getElementById('postId').value = "";
                document.getElementById('postDayId').value = dateStr;
                document.getElementById('postTitle').value = "";
                document.getElementById('postCategory').value = "motivacao";
                document.getElementById('postStatus').value = "draft";
                document.getElementById('postCaption').value = "";
                btnDelete.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('postModal').classList.remove('active');
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            if (window.innerWidth < 768) {
                // Mobile behavior
                sb.classList.toggle('open');
            } else {
                // Tablet behavior (opcional, pode esconder/mostrar)
                sb.classList.toggle('collapsed');
            }
        }

        function changeWeek(offset) {
            AppState.currentDate.setDate(AppState.currentDate.getDate() + (offset * 7));
            renderCalendar();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        /* --- PERSISTÊNCIA E EXPORTAÇÃO --- */

        function saveToStorage() {
            localStorage.setItem('instaPlannerPosts', JSON.stringify(AppState.posts));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('instaPlannerPosts');
            if (saved) {
                AppState.posts = JSON.parse(saved);
            }
        }

        function resetData() {
            if(confirm("Deseja apagar todos os posts planejados?")) {
                localStorage.removeItem('instaPlannerPosts');
                AppState.posts = {};
                renderCalendar();
                showToast("Calendário limpo!");
            }
        }

        function exportCalendar() {
            const element = document.getElementById('captureArea');
            showToast("Gerando imagem...");
            
            html2canvas(element, {
                scale: 2, // Melhor qualidade
                backgroundColor: "#F4F6F8"
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `calendario-instagram-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // Setup inicial de events
        function setupEventListeners() {
            // Fechar modal ao clicar fora
            document.getElementById('postModal').addEventListener('click', (e) => {
                if(e.target === document.getElementById('postModal')) closeModal();
            });
        }
    </script>
</body>
</html>